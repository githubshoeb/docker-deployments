# version: "3.7"
services:
  nginx:
    image: nginx:latest
    ports:
      - "8181:80"
    volumes:
      - shared-files:/var/www/html
      - ./default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - php-fpm
    networks:
      - dev

  php-fpm:
    depends_on:
      - init
    build:
      context: ./laravel-cicd # Path to the directory containing your Dockerfile and source code
      dockerfile: Dockerfile # Name of your Dockerfile if it's not named 'Dockerfile'
    image: laravel-crm:latest
    container_name: "php-fpm"
    restart: always
    env_file:
      - .env.crm
    ports:
      - "9000:9000"
    volumes:
      - shared-files:/var/www/html
    # environment:
    #   # Define environment variables from ConfigMap here
    #   # Example:
    #   # ENV_VAR_NAME: ${ENV_VAR_NAME}
    user: "1000:1000"  # Adjust user/group ID as needed
    networks:
      - dev

  init:
    image: laravel-crm:latest
    env_file:
      - .env.crm
    command: ["/bin/sh", "-c", "cp -r /var/www/html/. /tmp"]
    volumes:
      - shared-files:/tmp
    networks:
      - dev

  set-permissions:
    image: busybox
    command: ["sh", "-c", "chmod -R 777 /var/www/html/storage && chmod -R 777 /var/www/html/public && chmod -R 777 /var/www/html/node_modules && chmod -R 777 /var/www/html/database && chmod -R 777 /var/www/html/bootstrap/cache && chmod 666 /var/www/html/composer.json && chmod 666 /var/www/html/composer.lock && chmod -R 777 /var/www/html/vendor && chmod -R 777 /var/www/html/config && chmod -R 777 /var/www/html/resources"]
    volumes:
      - shared-files:/var/www/html
    networks:
      - dev

volumes:
  shared-files:
    driver: local
  # nginx-config-volume:
  #   driver: local
  # nginx-config:
  #   driver: local

networks:
  dev:
    driver: bridge
    name: dev
